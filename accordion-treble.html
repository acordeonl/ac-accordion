<imports >
    <link rel="import" href="/bower_components/polymer/polymer.html">
    <link rel="import" href="/bower_components/ac-view/ac-led-group-behavior.html">
    <link rel="import" href="/bower_components/ac-view/view-audio.html">
    <link rel="import" href="/bower_components/local-dom/local-dom.html">
    <link rel="import" href="./accordion-button.html">
</imports>
<!--

Shows drop down menu (works on chrome)

### Usage
The list displayed in the drop down menu can be set as an attribute.

    <drop-menu list-items='["first" ,"second"]'></drop-menu>

For an overlayed drop menu:

    <drop-menu overlay-menu list-items='["first" ,"second"]'></drop-menu>

### Styling
 Custom property | Description | Default
----------------|-------------|----------
`--item-background-color` | List item backround color | `#f1ecef`
`--item-color` | List item color used for fonts | `#302f31`
`--button-close-color` | Icon button hover color | `4775D1`
`--button-background-color` | Drop menu's background color | `white`
`--button-close-color` | Icon button hover color | `4775D1`
`--icon-button` | Mixin applied the icon button | `{}`

@demo demo/drop-menu-demo.html
-->
<dom-module id="accordion-treble">
    <template>
        <style>
            :host {}
            local-dom {
                height: 100vh;
                width: 100%;
                @apply(--layout-center);
                @apply(--layout-justified);
                @apply(--layout-horizontal);
            }
            .col1 {
                height: 82vh;
                margin: 0;
                padding: 0;
                /*@apply(--layout-vertical);*/
                @apply(--layout-justified);
            }
            .col2 {
                height: 92vh;
                padding: 0;
                /*margin-left: -0.3vh;
                margin-right: -0.3vh;*/
                /*@apply(--layout-vertical);*/
                @apply(--layout-justified);
            }
            [mobile] .col2 {
                padding: 0;
            }
            [tablet] .col2 {
                padding: 0;
            }
            .vertical {
                @apply(--layout-vertical);
            }
            .reversedVertical {
                @apply(--layout-vertical-reverse);
            }
            .reversedHorizontal {
                @apply(--layout-horizontal-reverse);
            }
            .horizontal {
                @apply(--layout-horizontal);
            }
        </style>
        <!-- local DOM -->
        <view-audio
            id="trebleAudio"
            channel='0'
            default-audio-url='/data/accordion_synth/treble.mp3'>
        </view-audio>
        <local-dom class$="{{_computeRotation(rotation)}}" mobile="{{mobile}}" tablet="{{tablet}}" laptop="{{laptop}}">
            <div class$="col1 {{_computeColRotation(rotation)}}">
                <accordion-button acLed ac-id='21' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='22' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='23' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='24' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='25' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='26' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='27' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='28' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='29' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='30' channel='0' ></accordion-button>
            </div>
            <div class$="col2 {{_computeColRotation(rotation)}}">
                <accordion-button acLed ac-id='10' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='11' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='12' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='13' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='14' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='15' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='16' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='17' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='18' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='19' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='20' channel='0' ></accordion-button>
            </div>
            <div class$="col1 {{_computeColRotation(rotation)}}">
                <accordion-button acLed ac-id='0' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='1' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='2' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='3' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='4' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='5' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='6' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='7' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='8' channel='0' ></accordion-button>
                <accordion-button acLed ac-id='9' channel='0' ></accordion-button>
            </div>
        </local-dom>
    </template>
    <script>
        Polymer({
            is: "accordion-treble", observers: ['_swap(showingTreble)'],
            behaviors: [acLedGroupBehavior],
            listeners:{
                'click':'_toggleButtonNotes'
            },
            properties: {
                updateOpening:{
                    type:Boolean,
                    value:false
                },
                opening:{
                    type:Boolean,
                    value:false
                },
                keysDown:{
                    type:Array,
                    value:[]
                },
            },
        /* ------------------- acLed Action ------------------- */
            // override
            _mapMIDIEventToAcLedId: function(channel,midiNote){
                return Math.floor((midiNote - 24) / 2) ;
            },
            // override
            _mapMIDIEventToAcLedState: function(channel,midiNote){
                return ((midiNote - 24) % 2) + 1;
            },
        /* ------------------- GUI ------------------- */
            _computeRotation: function(rotation){
                if( rotation )
                    return "reversedHorizontal" ;
                return "horizontal" ;
            },
            _computeColRotation: function(rotation){
                if( rotation )
                    return "reversedVertical" ;
                return "vertical" ;
            },
            _swap: function (showingTreble) {
                if (showingTreble) {
                    this.playAnimation('entry');
                }
            },
        /* ------------------- Setup ------------------- */
            _onAddPitch: function(){
                this._setNoteNames() ;
            },
            _setNoteNames: function(){
                var nodeList = Polymer.dom(this.root).querySelectorAll('ACCORDION-BUTTON');
                for (var i = 0; i < nodeList.length; i++) {
                    var note1 = this.MIDIEventToNoteMap[nodeList[i].channel][nodeList[i].acId*2+24] ;
                    var note2 =this.MIDIEventToNoteMap[nodeList[i].channel][nodeList[i].acId*2+25] ;
                    nodeList[i].note1 ="C C#D EbE F F#G AbA BbB "  ;
                    nodeList[i].note1 = (nodeList[i].note1.substring((note1 % 12) * 2, (note1 % 12) * 2 + 2) + (Math.floor(note1 / 12) ).toString()).replace(" ", "");
                    nodeList[i].note2 = "C C#D EbE F F#G AbA BbB " ;
                    nodeList[i].note2 = (nodeList[i].note2.substring((note2 % 12) * 2, (note2 % 12) * 2 + 2) + (Math.floor(note2 / 12) ).toString()).replace(" ", "");
                }
            },
            _toggleButtonNotes: function(){
                var nodeList = Polymer.dom(this.root).querySelectorAll('ACCORDION-BUTTON');
                for (var i = 0; i < nodeList.length; i++) {
                    nodeList[i].toggleButtonNotes() ;
                }
            },
            updateOpening: async function(opening){
                if (opening !== this.opening) {
                    var arr = []
                    for (var i = 0; i < this.keysDown.length; i++) {
                        arr[i] = this.keysDown[i]
                    }
                    for (let i = 0; i < arr.length; i++)
                        this.onKeyboardNoteOff(arr[i]) ;
                    this.opening = opening ;
                    for (let i = 0; i < arr.length; i++)
                        this.onKeyboardNoteOn(arr[i]) ;
                }
            },
            //override
            onKeyboardNoteOn: function(key){
                for (var i = 0; i < this.keysDown.length; i++) {
                    if (this.keysDown[i] ===key) {
                        return ;
                    }
                }
                if (this.mapKeyboardToNote[key] !== undefined) {
                    var e = {};
                    e.playNow = 1;
                    e.midiNote = this.mapKeyboardToNote[key][1];
                    if (this.opening)
                        e.midiNote ++ ;
                    e.channel = this.mapKeyboardToNote[key][0];
                    e.origin = 'keyboard';
                    e.cmd = 'note-on';
                    this.keysDown.push(key) ;
                    this.onMIDIEvent(e) ;
                }
            },
            //override
            onKeyboardNoteOff: function(key){
                var flag = true ;
                for (var i = 0; i < this.keysDown.length; i++) {
                    if (this.keysDown[i] ===key) {
                        flag = false ;
                    }
                }
                if (flag)
                    return ;
                if (this.mapKeyboardToNote[key] !== undefined) {
                    var e = {};
                    e.playNow = 1;
                    e.midiNote = this.mapKeyboardToNote[key][1];
                    e.channel = this.mapKeyboardToNote[key][0];
                    if (this.opening)
                        e.midiNote ++ ;
                    e.origin = 'keyboard';
                    e.cmd = 'note-off';
                    var index = 0 ;
                    for (let i = 0; i < this.keysDown.length; i++) {
                        if (this.keysDown[i]===key) {
                            index = i ;
                        }
                    }
                    this.keysDown.splice(index, 1);
                    this.onMIDIEvent(e) ;
                }
            },
            ready: function () {
            /* ------------------- MIDI note mapping ------------------- */
                this._mapMIDIEventToNote(0,24,75);
                this._mapMIDIEventToNote(0,25,73);
                this._mapMIDIEventToNote(0,26,60);
                this._mapMIDIEventToNote(0,27,64);
                this._mapMIDIEventToNote(0,28,65);
                this._mapMIDIEventToNote(0,29,67);
                this._mapMIDIEventToNote(0,30,69);
                this._mapMIDIEventToNote(0,31,70);
                this._mapMIDIEventToNote(0,32,72);
                this._mapMIDIEventToNote(0,33,74);
                this._mapMIDIEventToNote(0,34,77);
                this._mapMIDIEventToNote(0,35,76);
                this._mapMIDIEventToNote(0,36,81);
                this._mapMIDIEventToNote(0,37,79);
                this._mapMIDIEventToNote(0,38,84);
                this._mapMIDIEventToNote(0,39,82);
                this._mapMIDIEventToNote(0,40,89);
                this._mapMIDIEventToNote(0,41,86);
                this._mapMIDIEventToNote(0,42,93);
                this._mapMIDIEventToNote(0,43,88);
                this._mapMIDIEventToNote(0,44,66);
                this._mapMIDIEventToNote(0,45,68);
                this._mapMIDIEventToNote(0,46,55);
                this._mapMIDIEventToNote(0,47,59);
                this._mapMIDIEventToNote(0,48,60);
                this._mapMIDIEventToNote(0,49,62);
                this._mapMIDIEventToNote(0,50,64);
                this._mapMIDIEventToNote(0,51,65);
                this._mapMIDIEventToNote(0,52,67);
                this._mapMIDIEventToNote(0,53,69);
                this._mapMIDIEventToNote(0,54,72);
                this._mapMIDIEventToNote(0,55,71);
                this._mapMIDIEventToNote(0,56,76);
                this._mapMIDIEventToNote(0,57,74);
                this._mapMIDIEventToNote(0,58,79);
                this._mapMIDIEventToNote(0,59,77);
                this._mapMIDIEventToNote(0,60,84);
                this._mapMIDIEventToNote(0,61,81);
                this._mapMIDIEventToNote(0,62,88);
                this._mapMIDIEventToNote(0,63,83);
                this._mapMIDIEventToNote(0,64,91);
                this._mapMIDIEventToNote(0,65,86);
                this._mapMIDIEventToNote(0,66,61);
                this._mapMIDIEventToNote(0,67,63);
                this._mapMIDIEventToNote(0,68,55);
                this._mapMIDIEventToNote(0,69,57);
                this._mapMIDIEventToNote(0,70,59);
                this._mapMIDIEventToNote(0,71,60);
                this._mapMIDIEventToNote(0,72,62);
                this._mapMIDIEventToNote(0,73,64);
                this._mapMIDIEventToNote(0,74,67);
                this._mapMIDIEventToNote(0,75,66);
                this._mapMIDIEventToNote(0,76,71);
                this._mapMIDIEventToNote(0,77,69);
                this._mapMIDIEventToNote(0,78,74);
                this._mapMIDIEventToNote(0,79,72);
                this._mapMIDIEventToNote(0,80,79);
                this._mapMIDIEventToNote(0,81,76);
                this._mapMIDIEventToNote(0,82,83);
                this._mapMIDIEventToNote(0,83,78);
                this._mapMIDIEventToNote(0,84,86);
                this._mapMIDIEventToNote(0,85,81);

                this._setChord(60,'M',[[0,48,50,52]]) ;
                this._setChord(60,'m',[[0,67,71,29]]) ;
                this._setChord(73,'M',[[0,45,25,51]]) ;
                this._setChord(73,'m',[[0,45,25,73]]) ;
                this._setChord(62,'M',[[0,49,75,77]]) ;
                this._setChord(62,'m',[[0,51,49,53]]) ;
                this._setChord(63,'M',[[0,67,29,31]]) ;
                this._setChord(63,'m',[[0,67,75,31]]) ;
                this._setChord(64,'M',[[0,45,47,73]]) ;
                this._setChord(64,'m',[[0,46,70,50]]) ;
                this._setChord(65,'M',[[0,28,30,32]]) ;
                this._setChord(65,'M (2)',[[0,51,71,53]]) ;
                this._setChord(65,'m',[[0,45,71,51]]) ;
                this._setChord(66,'M',[[0,25,75,31]]) ;
                this._setChord(66,'m',[[0,75,77,25]]) ;
                this._setChord(66,'m (2)',[[0,30,44,66]]) ;
                this._setChord(55,'M',[[0,68,70,72]]) ;
                this._setChord(67,'M',[[0,29,55,57]]) ;
                this._setChord(67,'m',[[0,29,31,33]]) ;
                this._setChord(68,'M',[[0,45,67,71]]) ;
                this._setChord(68,'m',[[0,45,67,55]]) ;
                this._setChord(68,'m (2)',[[0,45,67,47]]) ;
                this._setChord(69,'M',[[0,66,50,30]]) ;
                this._setChord(69,'M (2)',[[0,25,53,35]]) ;
                this._setChord(69,'M (3)',[[0,25,27,53]]) ;
                this._setChord(57,'m',[[0,69,71,73]]) ;
                this._setChord(69,'m',[[0,48,50,30]]) ;
                this._setChord(69,'m (2)',[[0,48,50,30]]) ;
                this._setChord(69,'m (3)',[[0,30,32,56]]) ;
                this._setChord(70,'M',[[0,49,51,31]]) ;
                this._setChord(70,'M (2)',[[0,31,33,59]]) ;
                this._setChord(70,'m',[[0,25,51,31]]) ;
                this._setChord(82,'M',[[0,59,39,41]]) ;
                this._setChord(71,'M',[[0,67,75,55]]) ;
                this._setChord(71,'m',[[0,55,57,83]]) ;
                this._setChord(59,'m',[[0,44,70,72]]) ;
                this._setChord(59,'m (2)',[[0,47,49,75]]) ;

                this._setKeyboardToNote('w',[0,24]) ;
                this._setKeyboardToNote('e',[0,26]) ;
                this._setKeyboardToNote('r',[0,28]) ;
                this._setKeyboardToNote('t',[0,30]) ;
                this._setKeyboardToNote('y',[0,32]) ;
                this._setKeyboardToNote('u',[0,34]) ;
                this._setKeyboardToNote('i',[0,36]) ;
                this._setKeyboardToNote('o',[0,38]) ;
                this._setKeyboardToNote('p',[0,40]) ;
                this._setKeyboardToNote('[',[0,42]) ;
                this._setKeyboardToNote('a',[0,44]) ;
                this._setKeyboardToNote('s',[0,46]) ;
                this._setKeyboardToNote('d',[0,48]) ;
                this._setKeyboardToNote('f',[0,50]) ;
                this._setKeyboardToNote('g',[0,52]) ;
                this._setKeyboardToNote('h',[0,54]) ;
                this._setKeyboardToNote('j',[0,56]) ;
                this._setKeyboardToNote('k',[0,58]) ;
                this._setKeyboardToNote('l',[0,60]) ;
                this._setKeyboardToNote(';',[0,62]) ;
                this._setKeyboardToNote('0',[0,64]) ;
                this._setKeyboardToNote('z',[0,66]) ;
                this._setKeyboardToNote('x',[0,68]) ;
                this._setKeyboardToNote('c',[0,70]) ;
                this._setKeyboardToNote('v',[0,72]) ;
                this._setKeyboardToNote('b',[0,74]) ;
                this._setKeyboardToNote('n',[0,76]) ;
                this._setKeyboardToNote('m',[0,78]) ;
                this._setKeyboardToNote(',',[0,80]) ;
                this._setKeyboardToNote('.',[0,82]) ;
                this._setKeyboardToNote('/',[0,84]) ;

                this._setNoteNames() ;
            }
        });
    </script>
</dom-module>
