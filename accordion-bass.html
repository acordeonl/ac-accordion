<imports >
    <link rel="import" href="../polymer/polymer-element.html">
    <link rel="import" href="../ac-view/ac-led-group-behavior.html">
    <link rel="import" href="../ac-view/view-audio.html">
    <link rel="import" href="../local-dom/local-dom.html">
    <link rel="import" href="./accordion-button.html">
    <script src="./bassButtonNoteMapping.js"></script>
</imports>

<dom-module id="accordion-bass">
    <template>
        <style>
            local-dom {
                height: 100vh;
                @apply --layout-center;
                @apply --layout-justified;
            }
            .col {
                padding: 1.3vw;
                height: 51vh;
                @apply --layout-justified;
            }
            [mobile] .col {
                padding: 3vw;
            }
            [tablet] .col {
                padding: 1.2vw;
            }
            .vertical {
                @apply --layout-vertical;
            }
            .reversedVertical {
                @apply --layout-vertical-reverse;
            }
            .reversedHorizontal {
                @apply --layout-horizontal-reverse;
            }
            .horizontal {
                @apply --layout-horizontal;
            }
        </style>
        <!-- local DOM -->
        <view-audio id="bassNotesAudio" channel='1' default-audio-url='/data/accordion_synth/bass_notes.mp3'></view-audio>
        <view-audio id="bassChordsAudio" channel='2' default-audio-url='/data/accordion_synth/bass_chords.mp3'></view-audio>
        <local-dom mobile="{{mobile}}" tablet="{{tablet}}" laptop="{{laptop}}" class$="{{_computeRotation(___acV_rotation)}}">
            <div class$="col {{_computeColRotation(___acV_rotation)}}">
                <accordion-button is-bass acLed ac-id='3' channel='2' ></accordion-button>
                <accordion-button is-bass acLed ac-id='3' channel='1' ></accordion-button>
                <accordion-button is-bass acLed ac-id='4' channel='2' ></accordion-button>
                <accordion-button is-bass acLed ac-id='4' channel='1' ></accordion-button>
                <accordion-button is-bass acLed ac-id='5' channel='2' ></accordion-button>
                <accordion-button is-bass acLed ac-id='5' channel='1' ></accordion-button>
            </div>
            <div class$="col {{_computeColRotation(___acV_rotation)}}">
                <accordion-button is-bass acLed ac-id='0' channel='2' ></accordion-button>
                <accordion-button is-bass acLed ac-id='0' channel='1' ></accordion-button>
                <accordion-button is-bass acLed ac-id='1' channel='2' ></accordion-button>
                <accordion-button is-bass acLed ac-id='1' channel='1' ></accordion-button>
                <accordion-button is-bass acLed ac-id='2' channel='2' ></accordion-button>
                <accordion-button is-bass acLed ac-id='2' channel='1' ></accordion-button>
            </div>
        </local-dom>
    </template>
    <script>
        class AccordionBass extends ACLedGroup {
            static get is() { return 'accordion-bass'; }
            static get properties() {return {
                buttonCloseNote: {type: Array,value: []},
                buttonOpenNote: {type: Array,value: []},
                chordButtonCloseNote: {type: Array,value: []},
                chordButtonOpenNote: {type: Array,value: []}
            }}
            constructor() {
                super();
            }
        /* ------------------- acLed Action ------------------- */
            ___acV_mapMIDIEventToAcLedId (channel, midiNote) {
                if (channel === 1)
                    return [Math.floor((midiNote - 48) / 2)];
                if (channel === 2) {
                    return [Math.floor(midiNote / 2)];
                }
            }
            ___acV_mapMIDIEventToAcLedState (channel, midiNote) {
                if (channel === 1)
                    return [((midiNote - 48) % 2) + 1];
                if (channel === 2){
                    return [(midiNote % 2) + 1];
                }
            }
            ___acV_handleAddPitch (note,channel,diff) {
                if (channel === 1)
                    return this._changeBassNotesPitch(note,diff);
                if (channel === 2) {
                    var newNote = this._changeChordsPitch(note,diff);
                    return newNote ;
                }
            }
        /* ------------------- Change pitch helpers ------------------- */
            _checkBassNotes (note) {
                if (note > 59)
                    return note - 60 + 48;
                else if (note < 48)
                    return 59 - 47 + note;
                return note;
            }
            _changeBassNotesPitch (note,diff) {
                var subs = false;
                if (diff < 0) {
                    subs = true;
                    diff *= -1;
                }
                if (!subs)
                    note += (diff % 12);
                else
                    note -= (diff % 12);
                return this._checkBassNotes(note);
            }
            _changeChordsPitch (note,diff) {
                if (diff === 0)
                    return note;
                if (diff > 0) {
                    note = bassChordsNextNote[note];
                    note = this._changeChordsPitch(note,diff - 1);
                }
                else{
                    note = bassChordspreviousNote[note];
                    note = this._changeChordsPitch(note,diff + 1);
                }
                return note ;
            }
        /* ------------------- GUI  ------------------- */
            _swap (showingTreble) {
                if (!showingTreble) {
                    this.playAnimation('entry');
                }
            }
            _computeRotation (rotation) {
                if (rotation)
                    return "reversedHorizontal";
                return "horizontal";
            }
            _computeColRotation (rotation) {
                if (rotation)
                    return "reversedVertical";
                return "vertical";
            }
        /* ------------------- Setup ------------------- */
            ___acV_onAddPitch(){
                this._setNoteNames() ;
            }
            _setNoteNames(){
                var nodeList = Polymer.dom(this.root).querySelectorAll('ACCORDION-BUTTON');
                for (var i = 0; i < nodeList.length; i++) {
                    if (nodeList[i].channel === 2 )
                        continue ;
                    var note1 = this.___acV_MIDIEventToNoteMap[nodeList[i].channel][nodeList[i].acId*2+48] ;
                    var note2 =this.___acV_MIDIEventToNoteMap[nodeList[i].channel][nodeList[i].acId*2+49] ;
                    nodeList[i].note1 ="C C#D EbE F F#G AbA BbB "  ;
                    nodeList[i].note1 = (nodeList[i].note1.substring((note1 % 12) * 2, (note1 % 12) * 2 + 2) + (Math.floor(note1 / 12) ).toString()).replace(" ", "");
                    nodeList[i].note2 = "C C#D EbE F F#G AbA BbB " ;
                    nodeList[i].note2 = (nodeList[i].note2.substring((note2 % 12) * 2, (note2 % 12) * 2 + 2) + (Math.floor(note2 / 12) ).toString()).replace(" ", "");
                }
            }
            ready() {
                super.ready() ;
            /* ------------------- MIDI note mapping ------------------- */
                //bass notes
                this.___acV_mapMIDIEventToNote(1,48,55);
                this.___acV_mapMIDIEventToNote(1,49,50);
                this.___acV_mapMIDIEventToNote(1,50,48);
                this.___acV_mapMIDIEventToNote(1,51,55);
                this.___acV_mapMIDIEventToNote(1,52,53);
                this.___acV_mapMIDIEventToNote(1,53,48);
                this.___acV_mapMIDIEventToNote(1,54,52);
                this.___acV_mapMIDIEventToNote(1,55,57);
                this.___acV_mapMIDIEventToNote(1,56,57);
                this.___acV_mapMIDIEventToNote(1,57,50);
                this.___acV_mapMIDIEventToNote(1,58,58);
                this.___acV_mapMIDIEventToNote(1,59,58);
                //bass chords
                this.___acV_mapMIDIEventToNote(2,0,35);
                this.___acV_mapMIDIEventToNote(2,1,26);
                this.___acV_mapMIDIEventToNote(2,2,15);
                this.___acV_mapMIDIEventToNote(2,3,35);
                this.___acV_mapMIDIEventToNote(2,4,22);
                this.___acV_mapMIDIEventToNote(2,5,15);
                this.___acV_mapMIDIEventToNote(2,6,41);
                this.___acV_mapMIDIEventToNote(2,7,3);
                this.___acV_mapMIDIEventToNote(2,8,5);
                this.___acV_mapMIDIEventToNote(2,9,24);
                this.___acV_mapMIDIEventToNote(2,10,9);
                this.___acV_mapMIDIEventToNote(2,11,9);

                this._setNoteNames() ;
            }
        }
        customElements.define('accordion-bass', AccordionBass);
    </script>
</dom-module>
