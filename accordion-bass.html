<imports >
    <link rel="import" href="/bower_components/polymer/polymer.html">
    <link rel="import" href="/bower_components/ac-view/ac-led-group-behavior.html">
    <link rel="import" href="/bower_components/ac-view/view-audio.html">
    <link rel="import" href="/bower_components/local-dom/local-dom.html">
    <link rel="import" href="./accordion-button.html">
    <script src="./bassButtonNoteMapping.js"></script>
</imports>
<!--

Shows drop down menu (works on chrome)

### Usage
The list displayed in the drop down menu can be set as an attribute.

    <drop-menu list-items='["first" ,"second"]'></drop-menu>

For an overlayed drop menu:

    <drop-menu overlay-menu list-items='["first" ,"second"]'></drop-menu>

### Styling
 Custom property | Description | Default
----------------|-------------|----------
`--item-background-color` | List item backround color | `#f1ecef`
`--item-color` | List item color used for fonts | `#302f31`
`--button-close-color` | Icon button hover color | `4775D1`
`--button-background-color` | Drop menu's background color | `white`
`--button-close-color` | Icon button hover color | `4775D1`
`--icon-button` | Mixin applied the icon button | `{}`

@demo demo/drop-menu-demo.html
-->
<dom-module id="accordion-bass">
    <template>
        <style>
            :host {}
            local-dom {
                height: 100vh;
                @apply(--layout-center);
                @apply(--layout-justified);
            }
            .col {
                padding: 1.3vw;
                height: 51vh;
                @apply(--layout-justified);
            }
            [mobile] .col {
                padding: 3vw;
            }
            [tablet] .col {
                padding: 1.2vw;
            }
            .vertical {
                @apply(--layout-vertical);
            }
            .reversedVertical {
                @apply(--layout-vertical-reverse);
            }
            .reversedHorizontal {
                @apply(--layout-horizontal-reverse);
            }
            .horizontal {
                @apply(--layout-horizontal);
            }
        </style>
        <!-- local DOM -->
        <view-audio id="bassNotesAudio" channel='1' total-notes='12' default-audio-url='/data/accordion_synth/bass_notes'></view-audio>
        <view-audio id="bassChordsAudio" channel='2' total-notes='12' default-audio-url='/data/accordion_synth/bass_chords'></view-audio>
        <local-dom mobile="{{mobile}}" tablet="{{tablet}}" laptop="{{laptop}}" class$="{{_computeRotation(rotation)}}">
            <div class$="col {{_computeColRotation(rotation)}}">
                <accordion-button is-bass acLed ac-id='3' channel2 ></accordion-button>
                <accordion-button is-bass acLed ac-id='3' channel1 ></accordion-button>
                <accordion-button is-bass acLed ac-id='4' channel2 ></accordion-button>
                <accordion-button is-bass acLed ac-id='4' channel1 ></accordion-button>
                <accordion-button is-bass acLed ac-id='5' channel2 ></accordion-button>
                <accordion-button is-bass acLed ac-id='5' channel1 ></accordion-button>
            </div>
            <div class$="col {{_computeColRotation(rotation)}}">
                <accordion-button is-bass acLed ac-id='0' channel2 ></accordion-button>
                <accordion-button is-bass acLed ac-id='0' channel1 ></accordion-button>
                <accordion-button is-bass acLed ac-id='1' channel2 ></accordion-button>
                <accordion-button is-bass acLed ac-id='1' channel1 ></accordion-button>
                <accordion-button is-bass acLed ac-id='2' channel2 ></accordion-button>
                <accordion-button is-bass acLed ac-id='2' channel1 ></accordion-button>
            </div>
        </local-dom>
    </template>
    <script>
        Polymer({
            is: "accordion-bass",
            observers: ['_swap(showingTreble)'],
            listeners: {},
            behaviors: [acLedGroupBehavior],
            properties: {
                MIDIEventToNoteMap:{
                    type:Array,
                    value:[]
                },
                buttonCloseNote: {
                    type: Array,
                    value: []
                },
                buttonOpenNote: {
                    type: Array,
                    value: []
                },
                chordButtonCloseNote: {
                    type: Array,
                    value: []
                },
                chordButtonOpenNote: {
                    type: Array,
                    value: []
                }
            },
        /* ------------------- acLed Action ------------------- */
            _mapMIDIEventToAcLedId: function (midiNote, channel) {
                if (channel === 1)
                    return Math.floor((midiNote - 48) / 2);
                if (channel === 2) {
                    return Math.floor(midiNote / 2);
                }
            },
            _mapMIDIEventToAcLedState: function (midiNote, channel) {
                if (channel === 1)
                    return ((midiNote - 48) % 2) + 1;
                if (channel === 2){
                    return (midiNote % 2) + 1;
                }
            },
            _addPitch: function (note,channel,diff) {
                if (channel === 1)
                    return this._changeBassNotesPitch(note,diff);
                if (channel === 2) {
                    var newNote = this._changeChordsPitch(note,diff);
                    return newNote ;
                }
            },
        /* ------------------- Chords ------------------- */
            _displayChord: function (chord) {},
        /* ------------------- Change pitch helpers ------------------- */
            _checkBassNotes: function (note) {
                if (note > 59)
                    return note - 60 + 48;
                else if (note < 48)
                    return 59 - 47 + note;
                return note;
            },
            _changeBassNotesPitch: function (note,diff) {
                var subs = false;
                if (diff < 0) {
                    subs = true;
                    diff *= -1;
                }
                if (!subs)
                    note += (diff % 12);
                else
                    note -= (diff % 12);
                return this._checkBassNotes(note);
            },
            _changeChordsPitch: function (note,diff) {
                if (diff === 0)
                    return note;
                if (diff > 0) {
                    note = bassChordsNextNote[note];
                    note = this._changeChordsPitch(note,diff - 1);
                }
                else{
                    note = bassChordspreviousNote[note];
                    note = this._changeChordsPitch(note,diff + 1);
                }
                return note ;
            },
        /* ------------------- GUI  ------------------- */
            _swap: function (showingTreble) {
                if (!showingTreble) {
                    this.playAnimation('entry');
                }
            },
            _computeRotation: function (rotation) {
                if (rotation)
                    return "reversedHorizontal";
                return "horizontal";
            },
            _computeColRotation: function (rotation) {
                if (rotation)
                    return "reversedVertical";
                return "vertical";
            },
        /* ------------------- Setup ------------------- */
            ready: function () {
            /* ------------------- MIDI note mapping ------------------- */
                //bass notes
                this._mapMIDIEventToNote(1,48,55);
                this._mapMIDIEventToNote(1,49,50);
                this._mapMIDIEventToNote(1,50,48);
                this._mapMIDIEventToNote(1,51,55);
                this._mapMIDIEventToNote(1,52,53);
                this._mapMIDIEventToNote(1,53,48);
                this._mapMIDIEventToNote(1,54,52);
                this._mapMIDIEventToNote(1,55,57);
                this._mapMIDIEventToNote(1,56,57);
                this._mapMIDIEventToNote(1,57,50);
                this._mapMIDIEventToNote(1,58,58);
                this._mapMIDIEventToNote(1,59,58);
                //bass chords
                this._mapMIDIEventToNote(2,0,35);
                this._mapMIDIEventToNote(2,1,26);
                this._mapMIDIEventToNote(2,2,15);
                this._mapMIDIEventToNote(2,3,35);
                this._mapMIDIEventToNote(2,4,22);
                this._mapMIDIEventToNote(2,5,15);
                this._mapMIDIEventToNote(2,6,41);
                this._mapMIDIEventToNote(2,7,3);
                this._mapMIDIEventToNote(2,8,5);
                this._mapMIDIEventToNote(2,9,24);
                this._mapMIDIEventToNote(2,10,9);
                this._mapMIDIEventToNote(2,11,9);
            }
        });
    </script>
</dom-module>
