<imports >
    <link rel="import" href="/bower_components/polymer/polymer.html">
    <link rel="import" href="/bower_components/ac-view/ac-buttons-group-behavior.html">
    <link rel="import" href="/bower_components/ac-view/view-audio.html">
    <link rel="import" href="/bower_components/local-dom/local-dom.html">
    <link rel="import" href="./accordion-button.html">
    <script src="./bassButtonNoteMapping.js"></script>
</imports>
<!--

Shows drop down menu (works on chrome)

### Usage
The list displayed in the drop down menu can be set as an attribute.

    <drop-menu list-items='["first" ,"second"]'></drop-menu>

For an overlayed drop menu:

    <drop-menu overlay-menu list-items='["first" ,"second"]'></drop-menu>

### Styling
 Custom property | Description | Default
----------------|-------------|----------
`--item-background-color` | List item backround color | `#f1ecef`
`--item-color` | List item color used for fonts | `#302f31`
`--button-close-color` | Icon button hover color | `4775D1`
`--button-background-color` | Drop menu's background color | `white`
`--button-close-color` | Icon button hover color | `4775D1`
`--icon-button` | Mixin applied the icon button | `{}`

@demo demo/drop-menu-demo.html
-->
<dom-module id="accordion-bass">
    <template>
        <style>
            :host {}
            local-dom {
                height: 100vh;
                @apply(--layout-center);
                @apply(--layout-justified);
            }
            .col {
                padding: 1.3vw;
                height: 51vh;
                @apply(--layout-justified);
            }
            [mobile] .col {
                padding: 3vw;
            }
            [tablet] .col {
                padding: 1.2vw;
            }
            .vertical {
                @apply(--layout-vertical);
            }
            .reversedVertical {
                @apply(--layout-vertical-reverse);
            }
            .reversedHorizontal {
                @apply(--layout-horizontal-reverse);
            }
            .horizontal {
                @apply(--layout-horizontal);
            }
        </style>
        <!-- local DOM -->
        <view-audio
            id="bassNotesAudio"
            channel='1'
            total-notes='12'
            default-audio-url='/data/accordion_synth/bass_notes'>
        </view-audio>
        <view-audio
            id="bassChordsAudio"
            channel='3'
            total-notes='12'
            default-audio-url='/data/accordion_synth/bass_chords'>
        </view-audio>
        <local-dom mobile="{{mobile}}" tablet="{{tablet}}" laptop="{{laptop}}" class$="{{_computeRotation(rotation)}}">
            <div class$="col {{_computeColRotation(rotation)}}">
                <accordion-button button idChord3 button-type="bass_chord"></accordion-button>
                <accordion-button button id3 button-type="bass_note"></accordion-button>
                <accordion-button button idChord4 button-type="bass_chord"></accordion-button>
                <accordion-button button id4 button-type="bass_note"></accordion-button>
                <accordion-button button idChord5 button-type="bass_chord"></accordion-button>
                <accordion-button button id5 button-type="bass_note"></accordion-button>
            </div>
            <div class$="col {{_computeColRotation(rotation)}}">
                <accordion-button button idChord0 button-type="bass_chord"></accordion-button>
                <accordion-button button id0 button-type="bass_note"></accordion-button>
                <accordion-button button idChord1 button-type="bass_chord"></accordion-button>
                <accordion-button button id1 button-type="bass_note"></accordion-button>
                <accordion-button button idChord2 button-type="bass_chord"></accordion-button>
                <accordion-button button id2 button-type="bass_note"></accordion-button>
            </div>
        </local-dom>
    </template>
    <script>
        Polymer({
            is: "accordion-bass",
            observers: ['_swap(showingTreble)'],
            listeners: {},
            behaviors: [ACButtonsGroupBehavior],
            properties: {
                buttonCloseNote:{
                    type:Array,
                    value:[]
                },
                buttonOpenNote: {
                    type: Array,
                    value: []
                },
                chordButtonCloseNote: {
                    type: Array,
                    value: []
                },
                chordButtonOpenNote: {
                    type: Array,
                    value: []
                },
                pitch:{
                    type:Number,
                    value:67
                }
            },
            _loadNotes: function () {
                for ( var i = 0; i < 6; i++) {
                    this._loadNote('bassNotesAudio', this.buttonCloseNote[i]);
                    this._loadNote('bassNotesAudio', this.buttonOpenNote[i]);
                    this._loadNote('bassChordsAudio', this.chordButtonCloseNote[i]);
                    this._loadNote('bassChordsAudio', this.chordButtonOpenNote[i]);
                }
            },
            _setPitch: function (value) {
                var diff = value - this.pitch ;
                this.pitch += diff ;
                this._changeChordsPitch(diff);
                this._changeBassNotesPitch(diff);
            },
            _ButtonEventToAudio: function(e){
                var buttonId = Math.floor(e.button / 2);
                var note = (e.button % 2) ? this.chordButtonOpenNote[buttonId]: this.chordButtonCloseNote[buttonId] ;
                if (e.channel === 3) {
                    if (e.cmd === 'note-on')
                        this.$.bassChordsAudio._startAudio(note, buttonId, e);
                    else
                        this.$.bassChordsAudio._stopAudio(buttonId, e);
                }
                else if (e.channel === 1) {
                    buttonId = Math.floor((e.button-48) / 2);
                    if (e.cmd === 'note-on') {
                        note = ((e.button-48) % 2) ? this.buttonOpenNote[buttonId]: this.buttonCloseNote[buttonId];
                        this.$.bassNotesAudio._startAudio(note, buttonId, e);
                    }
                    else{
                        this.$.bassNotesAudio._stopAudio(buttonId, e);
                    }
                }
            },
            _ButtonEventToGUI: function(e){
                var buttonId = Math.floor(e.button / 2);
                var buttonState = 0 ;
                if (e.channel === 3) {
                    if (e.cmd === 'note-on')
                        buttonState = (e.button % 2) + 1 ;
                    this.displayEvent( 'idChord'+buttonId , buttonState , e ) ;
                }
                else if(e.channel === 1) {
                    buttonId = Math.floor((e.button-48) / 2);
                    if (e.cmd === 'note-on')
                        buttonState = ((e.button-48) % 2) + 1 ;
                    this.displayEvent( 'id'+buttonId , buttonState , e ) ;
                }
            },
            // _mapButtonToNote: function (e) {
            //     var note,which,button=e.button ;
            //     e.buttonState = 0 ;
            //     if(e.channel === 1) {
            //         button -= 48;
            //         which = Math.floor(button / 2);
            //         if (e.cmd === 'note-on') {
            //             e.buttonState = (button % 2) + 1 ;
            //             note = (button % 2) ? this.buttonOpenNote[which]: this.buttonCloseNote[which];
            //             this.$.bassNotesAudio._startAudio(note, button, e);
            //         }
            //         else{
            //             this.$.bassNotesAudio._stopAudio(button, e);
            //         }
            //         e.which = 'id'+which ;
            //     }
            //     if (e.channel === 3) {
            //         which = Math.floor(button / 2);
            //         if (e.cmd === 'note-on') {
            //             e.buttonState = (button % 2) + 1 ;
            //             note = (button % 2) ? this.chordButtonOpenNote[which]: this.chordButtonCloseNote[which];
            //             this.$.bassChordsAudio._startAudio(note, button, e);
            //         }
            //         else{
            //             this.$.bassChordsAudio._stopAudio(button, e);
            //         }
            //         e.which = 'idChord'+which ;
            //     }
            //     this.addGUIAction(e) ;
            // },
        /* ------------------- Chords ------------------- */
            _displayChord: function(chord){

            },
        /* ------------------- Change pitch helpers ------------------- */
            _checkBassNotes: function (note) {
                if (note > 59)
                    return note - 60 + 48;
                else if (note < 48)
                    return 59 - 47 + note;
                return note;
            },
            _changeBassNotesPitch: function (diff) {
                var subs = false;
                if (diff < 0) {
                    subs = true;
                    diff *= -1;
                }
                for (var i = 0; i < 6; i++) {
                    if (!subs) {
                        this.buttonCloseNote[i] += (diff % 12);
                        this.buttonOpenNote[i] += (diff % 12);
                    } else {
                        this.buttonCloseNote[i] -= (diff % 12);
                        this.buttonOpenNote[i] -= (diff % 12);
                    }
                    this.buttonCloseNote[i] = this._checkBassNotes(this.buttonCloseNote[i]);
                    this.buttonOpenNote[i] = this._checkBassNotes(this.buttonOpenNote[i]);
                }
            },
            _changeChordsPitch: function (diff) {
                if (diff === 0) {
                    return;
                }
                for (var i = 0; i < 42; i++) {
                    if (diff > 0) {
                        this.chordButtonCloseNote[i] = bassChordsNextNote[this.chordButtonCloseNote[i]];
                        this.chordButtonOpenNote[i] = bassChordsNextNote[this.chordButtonOpenNote[i]];
                    } else {
                        this.chordButtonCloseNote[i] = bassChordspreviousNote[this.chordButtonCloseNote[i]];
                        this.chordButtonOpenNote[i] = bassChordspreviousNote[this.chordButtonOpenNote[i]];
                    }
                }
                if (diff > 0)
                    this._changeChordsPitch(diff - 1);
                else {
                    this._changeChordsPitch(diff + 1);
                }
            },
        /* ------------------- GUI  ------------------- */
            _swap: function (showingTreble) {
                if (!showingTreble) {
                    this.playAnimation('entry');
                }
            },
            _computeRotation: function(rotation){
                if( rotation )
                    return "reversedHorizontal" ;
                return "horizontal" ;
            },
            _computeColRotation: function(rotation){
                if( rotation )
                    return "reversedVertical" ;
                return "vertical" ;
            },
        /* ------------------- Initialization ------------------- */
            ready: function () {
            /* ------------------- Button note mapping ------------------- */
                this.buttonCloseNote[0] = 55;
                this.buttonCloseNote[1] = 48;
                this.buttonCloseNote[2] = 53;
                this.buttonCloseNote[3] = 52;
                this.buttonCloseNote[4] = 57;
                this.buttonCloseNote[5] = 58;
                this.buttonOpenNote[0] = 50;
                this.buttonOpenNote[1] = 55;
                this.buttonOpenNote[2] = 48;
                this.buttonOpenNote[3] = 57;
                this.buttonOpenNote[4] = 50;
                this.buttonOpenNote[5] = 58;
                this.chordButtonCloseNote[0] = 35;
                this.chordButtonCloseNote[1] = 15;
                this.chordButtonCloseNote[2] = 22;
                this.chordButtonCloseNote[3] = 41;
                this.chordButtonCloseNote[4] = 5;
                this.chordButtonCloseNote[5] = 9;
                this.chordButtonOpenNote[0] = 26;
                this.chordButtonOpenNote[1] = 35;
                this.chordButtonOpenNote[2] = 15;
                this.chordButtonOpenNote[3] = 3;
                this.chordButtonOpenNote[4] = 24;
                this.chordButtonOpenNote[5] = 9;
            }
        });
    </script>
</dom-module>
